<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Recadinhosâ„¢ â€” Chat</title>
</head>
<body>

<table>
  <tr>
    <h1><strong>Recadinhosâ„¢</strong></h1>
  </tr>
  <tr>
    <td>
      [ <a href="index.html">ğŸ  InÃ­cio</a> ]
      [ <a href="Sobre.html">ğŸ“„ Sobre</a> ]
      [ <a href="Criar_conta.html">ğŸ™‚ Criar conta / Entrar</a> ]
      [ <a href="Postagens.html">ğŸ“§ Postagens</a> ]
      [ <a href="Chat.html">ğŸ’¬ Chat</a> ]
      [ <a href="Sair.html">âŒ Sair</a> ]
    </td>
  </tr>
</table>

<h1>ğŸ’¬ Chat Privado</h1>
<p>Logado como: <span id="usuarioAtual"></span></p>

<table border="1" width="100%">
  <tr>
    <!-- Barra lateral -->
    <td width="30%" valign="top">
      <h3>Contatos</h3>
      <button onclick="abrirAdicionarContato()">â• Adicionar</button>
      <div id="listaContatos"></div>
    </td>

    <!-- Ãrea de chat -->
    <td width="70%" valign="top">
      <h3 id="tituloChat">Nenhum chat selecionado</h3>

      <div id="statusUsuario"></div>
      <div id="digitando"></div>

      <div id="areaMensagens" style="height:300px; overflow-y:scroll; border:1px solid #000; padding:5px;"></div>

      <br>

      <textarea id="msg" rows="3" cols="50" disabled oninput="avisarDigitando()"></textarea><br>
      <button id="btnEnviar" disabled onclick="enviarMensagem()">Enviar</button>
      <button id="btnChamar" disabled onclick="chamarUsuario()">ğŸ“¢ Chamar</button>
    </td>
  </tr>
</table>

<!-- Pop-up -->
<div id="popupAdicionar" style="display:none; border:1px solid #000; padding:10px; width:250px; background:#fff;">
  <h3>Adicionar contato</h3>
  <input type="text" id="novoContato" placeholder="@usuario"><br><br>
  <button onclick="confirmarAdicionarContato()">Adicionar</button>
  <button onclick="fecharAdicionarContato()">Cancelar</button>
</div>

<script>

// --------------------------------------
// CARREGAR USUÃRIO
// --------------------------------------
let usuario = localStorage.getItem("usuario");
document.getElementById("usuarioAtual").innerText = usuario;

// CONTATO ATUAL DO CHAT
let conversandoCom = null;

// --------------------------------------
// LISTAR CONTATOS
// --------------------------------------
function carregarContatos() {
  google.script.run
    .withSuccessHandler(contatos => {
      let html = "";
      contatos.forEach(c => {
        if (c.usuario !== usuario) {
          html += `<div>
            <button onclick="abrirChat('${c.usuario}')">@${c.usuario}</button>
          </div>`;
        }
      });
      document.getElementById("listaContatos").innerHTML = html;
    })
    .listarContas();
}

// --------------------------------------
// ABRIR CHAT
// --------------------------------------
function abrirChat(destinatario) {
  conversandoCom = destinatario;
  document.getElementById("tituloChat").innerText = "Conversando com @" + destinatario;

  document.getElementById("msg").disabled = false;
  document.getElementById("btnEnviar").disabled = false;
  document.getElementById("btnChamar").disabled = false;

  carregarMensagens();
}

// --------------------------------------
// CARREGAR MENSAGENS A CADA 2s
// --------------------------------------
setInterval(() => {
  if (conversandoCom) carregarMensagens();
}, 2000);

function carregarMensagens() {
  google.script.run
    .withSuccessHandler(msgs => {
      const div = document.getElementById("areaMensagens");
      div.innerHTML = "";

      msgs.forEach(m => {
        const classe = m.remetente === usuario ? "me" : "ele";
        div.innerHTML += `<div class="${classe}">
          <strong>@${m.remetente}</strong><br>${m.mensagem}<br>
          <small>${m.data}</small>
        </div>`;
      });

      div.scrollTop = div.scrollHeight;
    })
    .listarMensagens(usuario, conversandoCom);
}

// --------------------------------------
// ENVIAR MENSAGEM
// --------------------------------------
function enviarMensagem() {
  const txt = document.getElementById("msg").value.trim();
  if (!txt) return;

  google.script.run.enviarMensagemPrivada(usuario, conversandoCom, txt);

  document.getElementById("msg").value = "";
  carregarMensagens();
}

// --------------------------------------
// "CHAMAR" â€” NOTIFICAÃ‡ÃƒO SKYPE
// --------------------------------------
function chamarUsuario() {
  google.script.run.enviarChamada(usuario, conversandoCom);
  alert("ğŸ“¢ Chamado enviado!");
}

// --------------------------------------
// ADICIONAR CONTATO
// --------------------------------------
function abrirAdicionarContato() {
  document.getElementById("popupAdicionar").style.display = "block";
}

function fecharAdicionarContato() {
  document.getElementById("popupAdicionar").style.display = "none";
}

function confirmarAdicionarContato() {
  let novo = document.getElementById("novoContato").value.replace("@", "");
  if (!novo) return;

  alert("Contato adicionado! (fake por enquanto)");

  fecharAdicionarContato();
}

// --------------------------------------
// DIGITANDO...
// --------------------------------------
let timeoutDigitando;

function avisarDigitando() {
  clearTimeout(timeoutDigitando);
  google.script.run.setDigitando(usuario, conversandoCom);

  timeoutDigitando = setTimeout(() => {
    google.script.run.setParouDigitando(usuario, conversandoCom);
  }, 1500);
}

</script>

</body>
</html>


