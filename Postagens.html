<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Recadinhos™ — Mural</title>
</head>
<body>

<table>
  <tr>
    <h1><strong>Recadinhos™</strong></h1>
  </tr>
  <tr>
    <td>
      [ <a href="index.html">🏠 Início</a> ]
      [ <a href="Sobre.html">📄 Sobre</a> ]
      [ <a href="Criar_conta.html">🙂 Criar conta</a> ]
      [ <a href="Postagens.html">📧 Postagens</a> ]
      [ <a href="Sair.html">❌ Sair</a> ]
    </td>
  </tr>
</table>

<h1>Mural de Recadinhos</h1>

<form id="formRecado">
  <label for="mensagem">Seu recadinho:</label><br>
  <textarea id="mensagem" name="mensagem" rows="5" cols="40" placeholder="Escreva algo... Você pode mencionar @nomes aqui!" required></textarea><br><br>

  <input type="submit" value="Publicar Recadinho">
  <input type="reset" value="Limpar">
</form>

<h2>Recadinhos Recentes:</h2>
<ul id="listaRecados"></ul>

<h2>Recadinhos pra Você:</h2>
<ul id="listaPraVoce"></ul>

<script>
// API do Google Sheets
const API_URL = "https://script.google.com/macros/s/AKfycbxFfDNxXYIRRE5JXTqro_09yMapNPyosCLKeSfeuN1KfXtK_Ez1XDJBMYwlNmJlNRizYA/exec";

const form = document.getElementById('formRecado');
const listaRecados = document.getElementById('listaRecados');
const listaPraVoce = document.getElementById('listaPraVoce');

let usuarioAtual = localStorage.getItem('usuarioLogado');

// Função para atualizar listas
function atualizarListas() {
  listaRecados.innerHTML = '';
  listaPraVoce.innerHTML = '';

  fetch(API_URL + "?tipo=recadinhos")
    .then(r => r.json())
    .then(recados => {
      recados.forEach(r => {
        // Todos veem
        const li = document.createElement('li');
        li.textContent = `@${r.autor}: ${r.mensagem}`;
        listaRecados.appendChild(li);

        // Mural "pra você"
        if(usuarioAtual && r.mensagem.includes('@'+usuarioAtual)){
          const li2 = document.createElement('li');
          li2.textContent = `@${r.autor} mencionou você: ${r.mensagem}`;
          listaPraVoce.appendChild(li2);
        }
      });
    });
}

// Publicar novo recado
form.addEventListener('submit', e => {
  e.preventDefault();
  const mensagem = document.getElementById('mensagem').value.trim();

  if(!usuarioAtual){
    alert("Você precisa estar logado para publicar.");
    return;
  }

  if(mensagem){
    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({
        tipo: 'novoRecado',
        autor: usuarioAtual,
        mensagem
      })
    })
    .then(r => r.json())
    .then(res => {
      if(res.status === "ok"){
        form.reset();
        atualizarListas();
      } else {
        alert(res.mensagem);
      }
    })
    .catch(() => alert('Erro ao publicar recadinho.'));
  }
});

// Atualiza a lista na abertura
atualizarListas();
</script>

</body>
</html>
